<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html, body { margin: 0; height: 100%; font-family: 'Inter', system-ui, sans-serif; }
.map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }

#controls {
  position: absolute; top: 10px; right: 10px; z-index: 20;
  background: white; padding: 10px; border: 1px solid #ccc;
  display: flex; flex-direction: column; gap: 5px;
  border-radius: 6px;
}

#hybridToggle {
  position: absolute; top: 180px; right: 10px; z-index: 20;
  background: white; padding: 8px; border: 1px solid #ccc;
  cursor: pointer; border-radius: 6px;
  width: 40px; height: 40px;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
#hybridToggle.active { background: #ddd; }
#hybridToggle img { width: 24px; height: 24px; }

button, select, input { font: 14px 'Inter', system-ui, sans-serif; }

#searchBox {
  width: 200px;
  padding: 4px;
  border-radius: 4px;
  border: 1px solid #ccc;
}

#searchResults {
  position: absolute;
  top: 38px;
  right: 10px;
  background: white;
  border: 1px solid #ccc;
  max-height: 180px;
  overflow-y: auto;
  width: 200px;
  z-index: 30;
  border-radius: 4px;
  display: none;
}

.searchItem {
  padding: 4px 6px;
  cursor: pointer;
}
.searchItem:hover { background: #eee; }

.route-info {
  position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
  background: white; padding: 8px 14px; border: 1px solid #333;
  font: 14px 'Inter', system-ui, sans-serif; z-index: 20;
  border-radius: 6px; opacity: 0.9;
  pointer-events: none;
}

.loading {
  position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
  background: yellow; padding: 6px 12px; border-radius: 4px;
  z-index: 40; font-weight: bold;
  display: none;
}

.attribution-text {
  position: absolute; bottom: 10px; right: 10px; z-index: 20;
  background: rgba(255,255,255,0.85); padding: 6px 10px;
  font: 12px 'Inter', system-ui, sans-serif;
  border-radius: 6px;
}

.maptiler-logo {
  position: absolute; left: 10px; bottom: 10px; z-index: 25;
}
</style>
</head>
<body>

<div id="map-streets" class="map"></div>
<div id="map-hybrid" class="map" style="display:none;"></div>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Search"/>
  <div id="searchResults"></div>
  <button id="toggleRoute">Enable Routing</button>
  <select id="mode">
    <option value="driving-car">Car</option>
    <option value="foot-walking">Walking</option>
    <option value="cycling-regular">Cycling</option>
  </select>
  <button id="resetRoute">Reset Route</button>
</div>

<div id="hybridToggle">
  <img src="https://raw.githubusercontent.com/finnhound/cartohound/7b3c8e14c393450a26d9d562c99016afad43d83a/stack%20(1).svg" alt="Hybrid Map Icon">
</div>

<div id="route-info" class="route-info" style="display:none;"></div>
<div id="loading" class="loading">Loading...</div>

<div class="attribution-text">
  © openrouteservice.org by HeiGIT | Map data © OpenStreetMap contributors | Tiles © MapTiler
</div>
<a class="maptiler-logo" href="https://www.maptiler.com" target="_blank" rel="noopener">
  <img src="https://api.maptiler.com/resources/logo.svg" alt="MapTiler logo">
</a>

<script>
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjFjMzkyNDVlOGIyNjQxYjVhMDRhNWEwNjdlMTM4MDc0IiwiaCI6Im11cm11cjY0In0=";
const MT_KEY = 'kUOJqqeRX1BMaXctsgK5';
const STREETS_URL = `https://api.maptiler.com/maps/019b2817-43ac-7a98-b15b-c204722a617b/style.json?key=${MT_KEY}`;
const HYBRID_URL = `https://api.maptiler.com/maps/hybrid/style.json?key=${MT_KEY}`;

const savedView = JSON.parse(localStorage.getItem('mapView') || 'null');
let currentStyle = localStorage.getItem('mapStyle') || 'streets';
let routingEnabled = JSON.parse(localStorage.getItem('mapRouteEnabled') || 'false');
let routingMode = document.getElementById('mode').value;

let routePoints = [];
let markers = [];
let searchMarker = null;
let searchMarkerName = '';
const routeInfo = document.getElementById('route-info');
const loadingEl = document.getElementById('loading');
const searchBox = document.getElementById('searchBox');
const searchResults = document.getElementById('searchResults');

// Initialize maps
const mapStreets = new maplibregl.Map({ container:'map-streets', style:STREETS_URL, center: savedView?.center||[0,0], zoom: savedView?.zoom ?? 1, attributionControl:false });
const mapHybrid = new maplibregl.Map({ container:'map-hybrid', style:HYBRID_URL, center: savedView?.center||[0,0], zoom: savedView?.zoom ?? 1, attributionControl:false });
[mapStreets, mapHybrid].forEach(m=>{ m.addControl(new maplibregl.NavigationControl({showCompass:true, showZoom:true}),'top-left'); });

// Hybrid toggle
const hybridToggleEl = document.getElementById('hybridToggle');
function showHybrid(isHybrid) {
  hybridToggleEl.classList.toggle('active', isHybrid);
  if(isHybrid){ document.getElementById('map-streets').style.display='none'; document.getElementById('map-hybrid').style.display='block'; mapHybrid.resize(); }
  else { document.getElementById('map-streets').style.display='block'; document.getElementById('map-hybrid').style.display='none'; mapStreets.resize(); }
  currentStyle = isHybrid?'hybrid':'streets';
  localStorage.setItem('mapStyle',currentStyle);
}
showHybrid(currentStyle==='hybrid');
hybridToggleEl.onclick = ()=>showHybrid(currentStyle==='streets');

// Sync & persist map views
let syncing=false;
function syncView(src,tgt){ if(syncing) return; syncing=true; const c=src.getCenter(), z=src.getZoom(); tgt.jumpTo({center:[c.lng,c.lat], zoom:z}); syncing=false; }
mapStreets.on('move',()=>syncView(mapStreets,mapHybrid));
mapHybrid.on('move',()=>syncView(mapHybrid,mapStreets));
function saveView(){ const activeMap = currentStyle==='streets'?mapStreets:mapHybrid; const c=activeMap.getCenter(), z=activeMap.getZoom(); localStorage.setItem('mapView',JSON.stringify({center:[c.lng,c.lat], zoom:z})); }
mapStreets.on('moveend', saveView); mapHybrid.on('moveend', saveView);

// Routing UI
const toggleRouteBtn = document.getElementById('toggleRoute');
function updateRouteButton(){ toggleRouteBtn.textContent = routingEnabled?'Disable Routing':'Enable Routing'; updateSearchPlaceholder(); }
updateRouteButton();
toggleRouteBtn.onclick = ()=>{ routingEnabled = !routingEnabled; localStorage.setItem('mapRouteEnabled',routingEnabled); updateRouteButton(); if(!routingEnabled) clearRoute(); };

document.getElementById('mode').onchange = function(){ routingMode = this.value; if(routePoints.length===2) fetchRoute(); };
document.getElementById('resetRoute').onclick = clearRoute;

// Search placeholder logic
function updateSearchPlaceholder(){
  if(!routingEnabled) searchBox.placeholder = "Search";
  else if(routingEnabled && routePoints.length===0) searchBox.placeholder = "Select starting location";
  else if(routingEnabled && routePoints.length===1) searchBox.placeholder = "Select ending location";
}
updateSearchPlaceholder();

// Add markers
function addMarker(map,lngLat,index,isSearch=false,name=''){
  const m = new maplibregl.Marker({draggable:!isSearch}).setLngLat(lngLat).addTo(map);
  if(isSearch){
    if(searchMarker) searchMarker.remove();
    searchMarker = m;
    searchMarkerName = name
    if(!routingEnabled){
      m.getElement().addEventListener('click', ()=>{ searchMarker.remove(); searchMarker = null; searchMarkerName=''; });
    }
    if(routingEnabled){
      if(routePoints.length===0) routePoints.push([lngLat[0], lngLat[1]]);
      else if(routePoints.length===1){ routePoints.push([lngLat[0], lngLat[1]]); fetchRoute(); }
    }
  } else {
    m.on('dragend',()=>{ routePoints[index] = [m.getLngLat().lng, m.getLngLat().lat]; if(routePoints.length===2) fetchRoute(); });
    markers.push(m);
  }
}

// Clear routing
function clearRoute(){
  markers.forEach(m=>m.remove());
  markers=[];
  routePoints=[];
  routeInfo.style.display='none';
  [mapStreets,mapHybrid].forEach(m=>{
    if(m.getLayer('route')) m.removeLayer('route');
    if(m.getSource('route')) m.removeSource('route');
  });
}

// Fetch route with delayed loading
let loadingTimer=null;
function fetchRoute(){
  if(routePoints.length!==2) return;
  loadingTimer = setTimeout(()=>{ loadingEl.style.display='block'; }, 700);
  const url = `https://api.openrouteservice.org/v2/directions/${routingMode}/geojson`;
  const body = { coordinates: [routePoints[0], routePoints[1]] };
  fetch(url,{method:'POST', headers:{ "Authorization": ORS_KEY, "Content-Type": "application/json"}, body: JSON.stringify(body)})
  .then(res=>res.json())
  .then(data=>{
    clearTimeout(loadingTimer); loadingEl.style.display='none';
    if(!data.features || !data.features[0]) return;
    const feature = data.features[0];
    const routeGeoJSON = feature.geometry;
    const distanceKm = (feature.properties.summary.distance/1000).toFixed(2);
    const durationMin = Math.round(feature.properties.summary.duration/60);
    routeInfo.innerHTML = `Distance: ${distanceKm} km | Duration: ${durationMin} min`;
    routeInfo.style.display='block';
    [mapStreets,mapHybrid].forEach(m=>{
      if(m.getSource('route')){ m.removeLayer('route'); m.removeSource('route'); }
      m.addSource('route',{type:'geojson', data:{type:'Feature', geometry:routeGeoJSON}});
      m.addLayer({id:'route', type:'line', source:'route', layout:{'line-cap':'round','line-join':'round'}, paint:{'line-color':'#0074d9','line-width':5}});
    });
  });
}

// Map clicks for routing
function onMapClick(e){
  if(!routingEnabled) return;
  const map = currentStyle==='streets'?mapStreets:mapHybrid;
  if(routePoints.length===2) clearRoute();
  const lngLat=[e.lngLat.lng,e.lngLat.lat];
  addMarker(map, lngLat, routePoints.length);
  routePoints.push(lngLat);
  if(routePoints.length===2) fetchRoute();
}
[mapStreets,mapHybrid].forEach(m=>m.on('click',onMapClick));

// Nominatim search with dropdown
let debounceTimer;
searchBox.addEventListener('input', ()=> {
  updateSearchPlaceholder();
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(()=> {
    const query = searchBox.value;
    if(!query) { searchResults.style.display='none'; return; }
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
      .then(res=>res.json())
      .then(results=>{
        searchResults.innerHTML='';
        if(!results || results.length===0) { searchResults.style.display='none'; return; }
        results.slice(0,5).forEach(r=>{
          const div = document.createElement('div');
          div.className='searchItem';
          div.textContent=r.display_name;
          div.onclick=()=> {
            searchResults.style.display='none';
            const lngLat = [parseFloat(r.lon), parseFloat(r.lat)];
            const map = currentStyle==='streets'?mapStreets:mapHybrid;
            map.flyTo({center:lngLat, zoom:14});
            addMarker(map, lngLat, 0, true, r.display_name);
            searchBox.value='';
            updateSearchPlaceholder();
          };
          searchResults.appendChild(div);
        });
        searchResults.style.display='block';
      });
  },300);
});
document.addEventListener('click', e=> { if(!searchResults.contains(e.target) && e.target!==searchBox) searchResults.style.display='none'; });
</script>
</body>
</html>

