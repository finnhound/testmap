<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; font-family:'Inter', sans-serif; overflow: hidden; background: #000; }
.map { 
    width:100%; 
    height:100%; 
    position:absolute; 
    top:0; 
    left:0; 
    transition: transform 0.3s ease;
    contain: strict;
}

#pan-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15; display: none; pointer-events: auto; }
#loading-bar { position: fixed; top: 0; left: 0; width: 0%; height: 6px; background: linear-gradient(90deg, #007aff, #5856d6); z-index: 200; transition: width 0.3s, opacity 0.3s; box-shadow: 0 2px 8px rgba(0,122,255,0.4); }

/* PC UI: Compact Top-Middle Pill */
#controls { 
    position:absolute; 
    top:20px; 
    left:50%; 
    transform: translateX(-50%); 
    z-index:25; 
    background:white; 
    padding:10px 16px; 
    border:1px solid #ccc; 
    display:flex; 
    flex-direction:row; 
    align-items: center;
    gap:12px; 
    border-radius:30px; 
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

#searchBox { 
    width:200px; 
    padding:8px 12px; 
    border-radius:6px; 
    border:1px solid #ddd; 
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
}

#mode, #resetRoute {
    opacity: 0;
    max-width: 0;
    overflow: hidden;
    padding: 0;
    margin: 0;
    border: none;
    transition: opacity 0.3s ease, max-width 0.3s ease, padding 0.3s ease, margin 0.3s ease;
}

#mode.visible, #resetRoute.visible {
    opacity: 1;
    max-width: 200px;
    padding: 8px 14px;
    border: 1px solid #ddd;
}

#searchResults { 
    position:absolute; 
    top:50px; 
    left:0; 
    background:white; 
    border:1px solid #ddd; 
    max-height:200px; 
    overflow-y:auto; 
    width:100%; 
    z-index:100; 
    border-radius:8px; 
    display:none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.searchItem { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
.searchItem:hover { background: #f0f4ff; color: #007aff; }

button, select {
    padding: 8px 14px;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    font-size: 14px;
}

.route-info { 
    position:absolute; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 24px; 
    font: bold 15px 'Inter', sans-serif; 
    z-index: 24; 
    border-radius: 25px; 
    display: none;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    opacity: 0;
    transition: opacity 0.35s ease;
    white-space: nowrap;
}

.route-info.visible { opacity: 1; display: block; }

#downloadMap, #gpsToggle, #hybridToggle, #toggleRoute { 
    position:absolute; 
    right:20px; 
    z-index:20; 
    background:white; 
    border:1px solid #ccc; 
    border-radius:10px; 
    width:44px; 
    height:44px; 
    display:flex; 
    align-items:center; 
    justify-content:center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#toggleRoute { top:15px; }
#gpsToggle { top:70px; }
#downloadMap { top:125px; }
#hybridToggle { top:180px; }
#toggleRoute.active, #gpsToggle.active { background: #007aff; }
#toggleRoute.active svg, #gpsToggle.active svg { stroke: white; }

.attribution-text { position:absolute; bottom:10px; right:10px; z-index:25; background:rgba(255,255,255,0.8); padding:4px 8px; font:10px 'Inter', sans-serif; border-radius:4px; }
.maptiler-logo { position:absolute; left:10px; bottom:10px; z-index:25; }
.maptiler-logo img { height: 20px; }

/* --- MOBILE ONLY FIXES (PORTRAIT) --- */
@media screen and (orientation: portrait) {
    #map-streets, #map-hybrid { 
        width: 45.45%; 
        height: 45.45%; 
        transform: scale(2.2); 
        transform-origin: top left;
    }
    
    #controls { 
        position: fixed;
        flex-direction: column;
        width: 180px; /* Slimmer for mobile scaling */
        padding: 12px; 
        top: 15px; 
        right: 15px;
        left: auto;
        transform: scale(1.8); /* Slightly reduced scale to fit screen better */
        transform-origin: top right;
        border-radius: 15px;
        gap: 8px;
    }
    
    #searchBox { width: 100%; font-size: 14px; }
    
    /* Route Info stacked BELOW controls on mobile */
    .route-info { 
        position: fixed;
        top: 240px; /* Calculated offset based on scaled controls height */
        right: 15px;
        left: auto;
        transform: scale(1.8);
        transform-origin: top right;
        max-width: 160px;
        white-space: normal;
        text-align: center;
        padding: 10px 15px;
    }

    #downloadMap { bottom: 740px; top: auto; right: 20px; transform: scale(2.2); transform-origin: right center; }
    #gpsToggle { bottom: 620px; top: auto; right: 20px; transform: scale(2.2); transform-origin: right center; }
    #hybridToggle { bottom: 500px; top: auto; right: 20px; transform: scale(2.2); transform-origin: right center; }
    
    .maplibregl-ctrl-group { display: none !important; }
}
</style>
</head>
<body>

<div id="loading-bar"></div>
<div id="pan-blocker"></div>

<div id="map-streets" class="map"></div>
<div id="map-hybrid" class="map" style="display:none;"></div>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Search"/>
  <div id="searchResults"></div>
  <select id="mode" style="display:none;">
    <option value="driving-car">ðŸš— Car</option>
    <option value="foot-walking">ðŸš¶ Walk</option>
    <option value="cycling-regular">ðŸš´ Bike</option>
  </select>
  <button id="resetRoute" style="display:none;">Reset</button>
</div>

<div id="downloadMap"><svg viewBox="0 0 24 24" fill="none" stroke="#5856d6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg></div>
<div id="toggleRoute">
  <svg viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="19" r="3"></circle><path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15"></path><circle cx="18" cy="5" r="3"></circle></svg>
</div>
<div id="gpsToggle"><svg viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></div>
<div id="hybridToggle"><img src="https://raw.githubusercontent.com/finnhound/cartohound/7b3c8e14c393450a26d9d562c99016afad43d83a/stack%20(1).svg" style="width:24px;"></div>

<div id="route-info" class="route-info"></div>

<div class="attribution-text">Â© OpenStreetMap | Â© MapTiler</div>
<a class="maptiler-logo" href="https://www.maptiler.com" target="_blank"><img src="https://api.maptiler.com/resources/logo.svg"></a>

<script>
const MT_KEY = 'OtdP8RQkvwYY4wHOxlrm';
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjFjMzkyNDVlOGIyNjQxYjVhMDRhNWEwNjdlMTM4MDc0IiwiaCI6Im11cm11cjY0In0=";
const STREETS_URL = `https://api.maptiler.com/maps/019b2817-43ac-7a98-b15b-c204722a617b/style.json?key=${MT_KEY}`;
const HYBRID_URL = `https://api.maptiler.com/maps/hybrid/style.json?key=${MT_KEY}`;

const isMobile = window.innerHeight > window.innerWidth;
const pinSize = isMobile ? 48 : 40;

let routingEnabled = false;
let currentStyle = 'streets';
let currentCoords = null;
let watchId = null;
let startMarker = null, endMarker = null, routePoints = [];

const mapStreets = new maplibregl.Map({ container:'map-streets', style:STREETS_URL, center: [0,0], zoom: 1, attributionControl:false });
const mapHybrid = new maplibregl.Map({ container:'map-hybrid', style:HYBRID_URL, center: [0,0], zoom: 1, attributionControl:false });

function setLoading(active) { document.getElementById('loading-bar').style.width = active ? '70%' : '0%'; }

// FIX: Corrected GPS heading logic (removed +90 offset)
function handleOrientation(event) {
    let heading = event.webkitCompassHeading || (360 - event.alpha);
    if (!heading || !userMarkerStreets) return;
    
    // SVG points North (0deg), so use raw heading
    userMarkerStreets.setRotation(heading);
    userMarkerHybrid.setRotation(heading);
}

document.getElementById('gpsToggle').onclick = async () => {
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        document.getElementById('gpsToggle').classList.remove('active');
        return;
    }
    
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        await DeviceOrientationEvent.requestPermission();
    }
    window.addEventListener('deviceorientation', handleOrientation, true);
    
    watchId = navigator.geolocation.watchPosition(pos => {
        currentCoords = [pos.coords.longitude, pos.coords.latitude];
        if (!userMarkerStreets) {
            const el = document.createElement('div');
            el.innerHTML = `<svg width="${pinSize}" height="${pinSize}" viewBox="0 0 40 40"><circle cx="20" cy="20" r="10" fill="#007aff" stroke="white" stroke-width="3"/><path d="M20 7L25 16H15L20 7Z" fill="#007aff" stroke="white" stroke-width="2"/></svg>`;
            userMarkerStreets = new maplibregl.Marker({element: el.cloneNode(true), rotationAlignment: 'map'}).setLngLat(currentCoords).addTo(mapStreets);
            userMarkerHybrid = new maplibregl.Marker({element: el.cloneNode(true), rotationAlignment: 'map'}).setLngLat(currentCoords).addTo(mapHybrid);
            mapStreets.flyTo({center: currentCoords, zoom: 17});
        }
        document.getElementById('gpsToggle').classList.add('active');
    });
};

document.getElementById('toggleRoute').onclick = function() {
    routingEnabled = !routingEnabled;
    const mode = document.getElementById('mode');
    const reset = document.getElementById('resetRoute');
    
    if (routingEnabled) {
        this.classList.add('active');
        mode.style.display = 'block';
        reset.style.display = 'block';
        setTimeout(() => { mode.classList.add('visible'); reset.classList.add('visible'); }, 50);
    } else {
        this.classList.remove('active');
        mode.classList.remove('visible');
        reset.classList.remove('visible');
        setTimeout(() => { mode.style.display = 'none'; reset.style.display = 'none'; }, 350);
        clearRoute();
    }
};

function clearRoute() {
    if (startMarker) startMarker.remove();
    if (endMarker) endMarker.remove();
    startMarker = endMarker = null;
    document.getElementById('route-info').classList.remove('visible');
}

document.getElementById('hybridToggle').onclick = () => {
    currentStyle = currentStyle === 'streets' ? 'hybrid' : 'streets';
    document.getElementById('map-streets').style.display = currentStyle === 'hybrid' ? 'none' : 'block';
    document.getElementById('map-hybrid').style.display = currentStyle === 'hybrid' ? 'block' : 'none';
};

// Sync maps
mapStreets.on('move', () => mapHybrid.jumpTo({ center: mapStreets.getCenter(), zoom: mapStreets.getZoom(), bearing: mapStreets.getBearing() }));
mapHybrid.on('move', () => mapStreets.jumpTo({ center: mapHybrid.getCenter(), zoom: mapHybrid.getZoom(), bearing: mapHybrid.getBearing() }));

</script>
</body>
</html>
