<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; font-family:'Inter', sans-serif; overflow: hidden; background: #000; }
.map { width:100%; height:100%; position:absolute; top:0; left:0; transition: transform 0.3s ease; }

/* Pan Blocker for GPS Mode */
#pan-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15; display: none; pointer-events: auto; }

/* Loading Indicator */
#loading-bar { position: fixed; top: 0; left: 0; width: 0%; height: 4px; background: #007aff; z-index: 200; transition: width 0.3s, opacity 0.3s; }

#controls { position:absolute; top:10px; right:10px; z-index:25; background:white; padding:10px; border:1px solid #ccc; display:flex; flex-direction:column; gap:5px; border-radius:6px; }

/* Side Dock Buttons */
#downloadMap { position:absolute; top:130px; right:10px; z-index:20; background:white; padding:8px; border-radius:6px; border:1px solid #ccc; cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
#gpsToggle { position:absolute; top:180px; right:10px; z-index:20; background:white; padding:8px; border:1px solid #ccc; cursor:pointer; border-radius:6px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; transition: background 0.2s; }
#hybridToggle { position:absolute; top:230px; right:10px; z-index:20; background:white; padding:8px; border:1px solid #ccc; cursor:pointer; border-radius:6px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; transition: background 0.2s; }

#hybridToggle.active, #gpsToggle.active { background:#ddd; }
#hybridToggle img, #gpsToggle svg { width:24px; height:24px; }

#searchBox { width:200px; padding:4px; border-radius:4px; border:1px solid #ccc; z-index:26; position:relative; }
#searchResults { position:absolute; top:42px; left:0; background:white; border:1px solid #ccc; max-height:180px; overflow-y:auto; width:100%; z-index:100; border-radius:4px; display:none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.searchItem { padding:8px; cursor:pointer; font-size: 13px; line-height: 1.2; border-bottom: 1px solid #eee; }
.searchItem:hover { background:#eee; }

.route-info { position:absolute; top: 25px; left: 50%; transform: translateX(-50%); background: white; padding: 12px 20px; border: 2px solid #333; font: bold 16px 'Inter', sans-serif; z-index: 25; border-radius: 8px; opacity: 0.95; pointer-events: none; white-space: nowrap; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.hint-text { position:absolute; top:290px; right:10px; z-index:20; background:rgba(255,255,255,0.95); padding:8px 12px; border:1px solid #ccc; border-radius:6px; font:12px 'Inter', sans-serif; max-width:200px; display:none; }

.attribution-text { position:absolute; bottom:10px; right:10px; z-index:25; background:rgba(255,255,255,0.85); padding:6px 10px; font:11px 'Inter', sans-serif; border-radius:6px; border:1px solid #ccc; }
.attribution-text a { color: #0074d9; text-decoration: none; }
.maptiler-logo { position:absolute; left:10px; bottom:10px; z-index:25; }

/* MOBILE ONLY SCALING (PORTRAIT) */
@media screen and (orientation: portrait) {
    #map-streets, #map-hybrid { width: 55.56%; height: 55.56%; transform: scale(1.8); transform-origin: top left; }
    
    #controls { 
        width: 200px; 
        padding: 18px; 
        transform: scale(1.5); 
        transform-origin: top right; 
        top: 15px; 
        right: 15px; 
        gap: 8px;
    }
    #searchBox { width: 170px; font-size: 16px !important; padding: 12px !important; }
    button, select { font-size: 15px !important; padding: 12px !important; }

    #downloadMap { top: 480px; right: 20px; transform: scale(1.7); }
    #gpsToggle { top: 560px; right: 20px; transform: scale(1.7); }
    #hybridToggle { top: 640px; right: 20px; transform: scale(1.7); }
    
    /* REMOVE MAPLIBRE ZOOM CONTROLS ON MOBILE */
    .maplibregl-ctrl-group { display: none !important; }
    
    .attribution-text { bottom: 20px; left: 50%; right: auto; transform: translateX(-50%) scale(1.3); width: 75%; text-align: center; padding: 10px; font-size: 11px; }
    .maptiler-logo { bottom: 100px; left: 25px; transform: scale(1.6); }

    #route-info { 
        top: 20px; 
        left: 20px; 
        transform: scale(1.3); 
        transform-origin: top left;
        width: auto; 
        max-width: 60%;
        white-space: normal;
        padding: 15px;
    }
}
</style>
</head>
<body>

<div id="loading-bar"></div>
<div id="pan-blocker"></div>

<div id="map-streets" class="map"></div>
<div id="map-hybrid" class="map" style="display:none;"></div>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Search"/>
  <div id="searchResults"></div>
  <button id="toggleRoute">Enable Routing</button>
  <select id="mode">
    <option value="driving-car">Car</option>
    <option value="foot-walking">Walking</option>
    <option value="cycling-regular">Cycling</option>
  </select>
  <button id="resetRoute">Reset Route</button>
</div>

<div id="downloadMap" title="Download Map">
  <svg viewBox="0 0 24 24" fill="none" stroke="#5856d6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg>
</div>

<div id="gpsToggle" title="Toggle GPS Orientation">
  <svg viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
</div>

<div id="hybridToggle"><img src="https://raw.githubusercontent.com/finnhound/cartohound/7b3c8e14c393450a26d9d562c99016afad43d83a/stack%20(1).svg" alt="Hybrid Map Icon"></div>

<div id="route-info" class="route-info"></div>
<div id="hint-text" class="hint-text"><strong>Click on route</strong> to add waypoints<br><strong>Click on</strong> waypoints to remove</div>

<div class="attribution-text">
    <a href="https://maplibre.org/" target="_blank">MapLibre</a> | 
    <a href="https://openrouteservice.org/" target="_blank">ORS</a> | 
    © <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> | 
    © <a href="https://www.maptiler.com/" target="_blank">MapTiler</a>
</div>
<a class="maptiler-logo" href="https://www.maptiler.com" target="_blank">
  <img src="https://api.maptiler.com/resources/logo.svg" alt="MapTiler logo">
</a>

<script>
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjFjMzkyNDVlOGIyNjQxYjVhMDRhNWEwNjdlMTM4MDc0IiwiaCI6Im11cm11cjY0In0=";
const MT_KEY = 'kUOJqqeRX1BMaXctsgK5';
const STREETS_URL = `https://api.maptiler.com/maps/019b2817-43ac-7a98-b15b-c204722a617b/style.json?key=${MT_KEY}`;
const HYBRID_URL = `https://api.maptiler.com/maps/hybrid/style.json?key=${MT_KEY}`;

const isMobile = window.innerHeight > window.innerWidth;
const pinSize = isMobile ? 48 : 40;

const savedView = JSON.parse(localStorage.getItem('mapView') || 'null');
let currentStyle = localStorage.getItem('mapStyle') || 'streets';
let routingEnabled = JSON.parse(localStorage.getItem('mapRouteEnabled') || 'false');
let watchId = null;
let currentCoords = null;
let searchTimeout = null;

let routePoints = [];
let startMarker = null, endMarker = null, waypointMarkers = [];
let userMarkerStreets = null, userMarkerHybrid = null;

const mapStreets = new maplibregl.Map({ container:'map-streets', style:STREETS_URL, center: savedView?.center||[0,0], zoom: savedView?.zoom ?? 1, attributionControl:false, preserveDrawingBuffer:true });
const mapHybrid = new maplibregl.Map({ container:'map-hybrid', style:HYBRID_URL, center: savedView?.center||[0,0], zoom: savedView?.zoom ?? 1, attributionControl:false, preserveDrawingBuffer:true });

    // Disable manual rotation/pitching on mobile to prevent accidental orientation changes
if (isMobile) {
    [mapStreets, mapHybrid].forEach(m => {
        m.touchZoomRotate.disableRotation();
        m.dragRotate.disable();
    });
}
if (!isMobile) {
    [mapStreets,mapHybrid].forEach(m=>{ m.addControl(new maplibregl.NavigationControl({showCompass:true, showZoom:true}),'top-left'); });
}

const arrowSVG = `<svg width="${pinSize}" height="${pinSize}" viewBox="0 0 40 40"><circle cx="20" cy="20" r="12" fill="#007aff" stroke="white" stroke-width="3"/><path d="M20 5L27 18H13L20 5Z" fill="#007aff" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>`;

function setLoading(active) {
    const bar = document.getElementById('loading-bar');
    if (active) {
        bar.style.opacity = '1';
        bar.style.width = '70%';
    } else {
        bar.style.width = '100%';
        setTimeout(() => { bar.style.opacity = '0'; bar.style.width = '0%'; }, 300);
    }
}

function showHybrid(isHybrid) {
    document.getElementById('map-streets').style.display = isHybrid ? 'none' : 'block';
    document.getElementById('map-hybrid').style.display = isHybrid ? 'block' : 'none';
    document.getElementById('hybridToggle').classList.toggle('active', isHybrid);
    currentStyle = isHybrid ? 'hybrid' : 'streets';
    const activeMap = isHybrid ? mapHybrid : mapStreets;
    activeMap.resize();
    localStorage.setItem('mapStyle', currentStyle);
    if(startMarker) startMarker.addTo(activeMap);
    if(endMarker) endMarker.addTo(activeMap);
    waypointMarkers.forEach(wp => wp.addTo(activeMap));
}
showHybrid(currentStyle === 'hybrid');

let syncing = false;
function syncView(src, tgt) {
    if (syncing) return;
    syncing = true;
    tgt.jumpTo({ center: src.getCenter(), zoom: src.getZoom(), bearing: src.getBearing() });
    syncing = false;
}
mapStreets.on('move', () => syncView(mapStreets, mapHybrid));
mapHybrid.on('move', () => syncView(mapHybrid, mapStreets));

// --- GPS TRACKING & ORBITAL LOCK ---
const HEADING_OFFSET = 50; // Adjust this number if the offset changes

async function handleOrientation(event) {
    let heading = null;

    if (event.webkitCompassHeading) {
        // iOS
        heading = event.webkitCompassHeading;
    } else if (event.absolute === true && event.alpha !== null) {
        // Android Absolute
        heading = (360 - event.alpha);
    } else if (event.alpha !== null) {
        // Fallback
        heading = (360 - event.alpha);
    }

    if (heading === null) return;

    // Apply the manual shift
    let correctedHeading = (heading + HEADING_OFFSET + 360) % 360;

    // Apply rotation to markers
    if (userMarkerStreets) userMarkerStreets.setRotation(correctedHeading);
    if (userMarkerHybrid) userMarkerHybrid.setRotation(correctedHeading);
    
    // Lock map bearing to corrected heading
    if (watchId !== null && currentCoords) {
        const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
        activeMap.jumpTo({ 
            center: currentCoords, 
            bearing: correctedHeading 
        });
    }
}

document.getElementById('gpsToggle').onclick = async () => {
    const blocker = document.getElementById('pan-blocker');
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        window.removeEventListener('deviceorientation', handleOrientation);
        watchId = null;
        currentCoords = null;
        blocker.style.display = 'none';
        document.getElementById('gpsToggle').classList.remove('active');
        if (userMarkerStreets) { userMarkerStreets.remove(); userMarkerHybrid.remove(); }
        userMarkerStreets = userMarkerHybrid = null;
        mapStreets.setBearing(0); mapHybrid.setBearing(0);
    } else {
        setLoading(true);
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            const res = await DeviceOrientationEvent.requestPermission();
            if (res !== 'granted') { setLoading(false); return; }
        }
        document.getElementById('gpsToggle').classList.add('active');
        blocker.style.display = 'block';
        window.addEventListener('deviceorientation', handleOrientation, true);
        watchId = navigator.geolocation.watchPosition(pos => {
            setLoading(false);
            currentCoords = [pos.coords.longitude, pos.coords.latitude];
            const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
            if (!userMarkerStreets) {
                const el1 = document.createElement('div'); el1.innerHTML = arrowSVG;
                const el2 = document.createElement('div'); el2.innerHTML = arrowSVG;
                userMarkerStreets = new maplibregl.Marker({element: el1, rotationAlignment: 'map'}).setLngLat(currentCoords).addTo(mapStreets);
                userMarkerHybrid = new maplibregl.Marker({element: el2, rotationAlignment: 'map'}).setLngLat(currentCoords).addTo(mapHybrid);
                activeMap.flyTo({center: currentCoords, zoom: 17});
            } else {
                userMarkerStreets.setLngLat(currentCoords); userMarkerHybrid.setLngLat(currentCoords);
            }
            activeMap.jumpTo({ center: currentCoords });
        }, err => setLoading(false), { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
    }
};

// --- ROUTING ENGINE ---
function updateSearchPlaceholder() {
    const sb = document.getElementById('searchBox');
    if (!routingEnabled) sb.placeholder = "Search";
    else if (!startMarker) sb.placeholder = "Select start";
    else if (!endMarker) sb.placeholder = "Select end";
    else sb.placeholder = "Search";
}

function clearRoute() {
    waypointMarkers.forEach(wp => wp.remove()); waypointMarkers = [];
    if (startMarker) { startMarker.remove(); startMarker = null; }
    if (endMarker) { endMarker.remove(); endMarker = null; }
    routePoints = [];
    document.getElementById('route-info').style.display = 'none';
    document.getElementById('hint-text').style.display = 'none';
    [mapStreets, mapHybrid].forEach(m => {
        if (m.getLayer('route')) m.removeLayer('route');
        if (m.getSource('route')) m.removeSource('route');
    });
    updateSearchPlaceholder();
}

function fetchRoute() {
    if (routePoints.length < 2) return;
    setLoading(true);
    fetch(`https://api.openrouteservice.org/v2/directions/${document.getElementById('mode').value}/geojson`, {
        method: 'POST', headers: { "Authorization": ORS_KEY, "Content-Type": "application/json" },
        body: JSON.stringify({ coordinates: routePoints })
    }).then(res => res.json()).then(data => {
        setLoading(false);
        if (!data.features?.[0]) return;
        const feat = data.features[0];
        document.getElementById('route-info').innerHTML = `Distance: ${(feat.properties.summary.distance / 1000).toFixed(2)} km | Time: ${Math.round(feat.properties.summary.duration / 60)} min`;
        document.getElementById('route-info').style.display = 'block';
        document.getElementById('hint-text').style.display = 'block';
        [mapStreets, mapHybrid].forEach(m => {
            if (m.getSource('route')) { m.removeLayer('route'); m.removeSource('route'); }
            m.addSource('route', { type: 'geojson', data: feat.geometry });
            m.addLayer({ id: 'route', type: 'line', source: 'route', paint: { 'line-color': '#0074d9', 'line-width': isMobile ? 10 : 6 } });
        });
    }).catch(() => setLoading(false));
}

function addPin(lngLat, isSearch = false) {
    const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
    let type = (!startMarker || (isSearch && document.getElementById('searchBox').placeholder.includes('start'))) ? 'start' : 'end';
    const el = document.createElement('div');
    el.style.width = pinSize+'px'; el.style.height = pinSize+'px';
    el.innerHTML = type === 'start' ? 
        `<svg viewBox="0 0 24 24" fill="none" stroke="#00c7be" stroke-width="3"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg>` :
        `<svg viewBox="0 0 24 24" fill="none" stroke="#ff9500" stroke-width="3"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg>`;
    
    const m = new maplibregl.Marker({ element: el, draggable: true }).setLngLat(lngLat).addTo(activeMap);
    if (type === 'start') { if(startMarker) startMarker.remove(); startMarker = m; routePoints[0] = lngLat; } 
    else { if(endMarker) endMarker.remove(); endMarker = m; routePoints[routePoints.length > 1 ? routePoints.length-1 : 1] = lngLat; }
    
    m.on('dragend', () => {
        const pos = [m.getLngLat().lng, m.getLngLat().lat];
        if (m === startMarker) routePoints[0] = pos; else routePoints[routePoints.length-1] = pos;
        fetchRoute();
    });
    if (startMarker && endMarker) fetchRoute();
    updateSearchPlaceholder();
}

function addWaypoint(lngLat) {
    const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
    const el = document.createElement('div');
    if (isMobile) {
        el.style.width = '30px'; el.style.height = '30px';
        el.style.background = 'rgba(139, 138, 235, 0.9)'; el.style.border = '3px solid white';
    } else {
        el.style.width = '18px'; el.style.height = '18px';
        el.style.background = 'rgba(139, 138, 235, 0.8)'; el.style.border = '2px solid white';
    }
    el.style.borderRadius = '50%';
    const wp = new maplibregl.Marker({ element: el, draggable: true }).setLngLat(lngLat).addTo(activeMap);
    routePoints.splice(routePoints.length - 1, 0, lngLat);
    waypointMarkers.push(wp);
    wp.on('dragend', () => {
        const idx = waypointMarkers.indexOf(wp);
        routePoints[idx + 1] = [wp.getLngLat().lng, wp.getLngLat().lat];
        fetchRoute();
    });
    wp.getElement().addEventListener('click', (e) => { 
        e.stopPropagation(); 
        const idx = waypointMarkers.indexOf(wp);
        if (idx > -1) {
            waypointMarkers.splice(idx, 1);
            routePoints.splice(idx + 1, 1);
            wp.remove();
            fetchRoute();
        }
    });
    fetchRoute();
}

[mapStreets, mapHybrid].forEach(m => m.on('click', (e) => {
    if (!routingEnabled) return;
    if (startMarker && endMarker && m.getLayer('route')) {
        const features = m.queryRenderedFeatures(e.point, { layers: ['route'] });
        if (features.length > 0) { addWaypoint([e.lngLat.lng, e.lngLat.lat]); return; }
    }
    addPin([e.lngLat.lng, e.lngLat.lat]);
}));

document.getElementById('searchBox').addEventListener('input', (e) => {
    const q = e.target.value;
    clearTimeout(searchTimeout);
    if(!q) { document.getElementById('searchResults').style.display = 'none'; return; }
    
    searchTimeout = setTimeout(() => {
        setLoading(true);
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
            .then(r => r.json()).then(data => {
                setLoading(false);
                const res = document.getElementById('searchResults'); res.innerHTML = '';
                data.slice(0,5).forEach(item => {
                    const d = document.createElement('div'); d.className = 'searchItem'; d.textContent = item.display_name;
                    d.onclick = () => {
                        const loc = [parseFloat(item.lon), parseFloat(item.lat)];
                        (currentStyle === 'streets' ? mapStreets : mapHybrid).flyTo({center: loc, zoom: 14});
                        if(routingEnabled) addPin(loc, true);
                        res.style.display = 'none'; e.target.value = '';
                    };
                    res.appendChild(d);
                });
                res.style.display = 'block';
            }).catch(() => setLoading(false));
    }, 1000);
});

document.getElementById('downloadMap').onclick = () => {
    const mapCanvas = (currentStyle === 'streets' ? mapStreets : mapHybrid).getCanvas();
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = mapCanvas.width; tempCanvas.height = mapCanvas.height;
    const ctx = tempCanvas.getContext('2d');
    ctx.drawImage(mapCanvas, 0, 0);
    const attr = "© MapLibre | © ORS | © OpenStreetMap | © MapTiler";
    ctx.font = "14px Inter, sans-serif";
    const textWidth = ctx.measureText(attr).width;
    ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
    ctx.fillRect(tempCanvas.width - textWidth - 20, tempCanvas.height - 35, textWidth + 20, 35);
    ctx.fillStyle = "#333";
    ctx.fillText(attr, tempCanvas.width - textWidth - 10, tempCanvas.height - 12);
    const a = document.createElement('a'); a.href = tempCanvas.toDataURL(); a.download = `map-${Date.now()}.png`; a.click();
};

document.getElementById('toggleRoute').onclick = function() {
    routingEnabled = !routingEnabled;
    this.textContent = routingEnabled ? 'Disable Routing' : 'Enable Routing';
    if (!routingEnabled) clearRoute();
    updateSearchPlaceholder();
};
document.getElementById('resetRoute').onclick = clearRoute;
document.getElementById('hybridToggle').onclick = () => showHybrid(currentStyle === 'streets');
</script>
</body>
</html>









