<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; font-family:'Inter', sans-serif; overflow: hidden; background: #000; }
.map { width:100%; height:100%; position:absolute; top:0; left:0; transition: transform 0.3s ease; }

#controls { position:absolute; top:10px; right:10px; z-index:25; background:white; padding:10px; border:1px solid #ccc; display:flex; flex-direction:column; gap:5px; border-radius:6px; }
#hybridToggle { position:absolute; top:180px; right:10px; z-index:20; background:white; padding:8px; border:1px solid #ccc; cursor:pointer; border-radius:6px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; transition: background 0.2s; }
#hybridToggle.active { background:#ddd; }
#hybridToggle img { width:24px; height:24px; }

#downloadMap { position:absolute; top:130px; right:10px; z-index:20; background:white; padding:8px; border-radius:6px; border:1px solid #ccc; cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
#downloadMap svg { width:24px; height:24px; }

button, select, input { font:14px 'Inter', sans-serif; }

#searchBox { width:200px; padding:4px; border-radius:4px; border:1px solid #ccc; z-index:26; position:relative; }
#searchResults { 
  position:absolute; top:42px; left:0; background:white; 
  border:1px solid #ccc; max-height:180px; overflow-y:auto; 
  width:100%; z-index:100; border-radius:4px; display:none; 
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.searchItem { padding:8px; cursor:pointer; font-size: 13px; line-height: 1.2; border-bottom: 1px solid #eee; }
.searchItem:last-child { border-bottom: none; }
.searchItem:hover { background:#eee; }

/* Desktop Route Info Base Style - Width set to auto to fit "Distance" text */
.route-info { position:absolute; top:50px; left:50%; transform:translateX(-50%); background:white; padding:8px 14px; border:1px solid #333; font:14px 'Inter', sans-serif; z-index:25; border-radius:6px; opacity:0.9; pointer-events:none; white-space: nowrap; }
.loading { position:absolute; top:20px; left:50%; transform:translateX(-50%); background:yellow; padding:6px 12px; border-radius:4px; z-index:40; font-weight:bold; display:none; }

.attribution-text { position:absolute; bottom:10px; right:10px; z-index:25; background:rgba(255,255,255,0.85); padding:6px 10px; font:11px 'Inter', sans-serif; border-radius:6px; border:1px solid #ccc; }
.attribution-text a { color: #0074d9; text-decoration: none; }
.maptiler-logo { position:absolute; left:10px; bottom:10px; z-index:25; }

.hint-text { position:absolute; top:240px; right:10px; z-index:20; background:rgba(255,255,255,0.95); padding:8px 12px; border:1px solid #ccc; border-radius:6px; font:12px 'Inter', sans-serif; max-width:200px; display:none; }

/* MOBILE ONLY SCALING (PORTRAIT) */
@media screen and (orientation: portrait) {
    #map-streets, #map-hybrid {
        width: 62.5%; 
        height: 62.5%;
        transform: scale(1.6);
        transform-origin: top left;
    }
    #controls { 
        width: 170px; 
        padding: 14px; 
        transform: scale(1.35);
        transform-origin: top right;
        top: 15px;
        right: 15px;
    }
    #searchBox { width: 145px; font-size: 16px !important; padding: 12px !important; }
    #searchResults { top: 50px; width: 100%; } 
    
    button, select { font-size: 15px !important; padding: 10px !important; }
    
    #downloadMap { top: 410px; right: 20px; transform: scale(1.7); }
    #hybridToggle { top: 490px; right: 20px; transform: scale(1.7); }
    
    .maplibregl-ctrl-group { transform: scale(1.7); transform-origin: top left; margin: 25px !important; }
    
    .attribution-text { 
        bottom: 15px; 
        left: 50%; 
        right: auto;
        transform: translateX(-50%) scale(1.1); 
        width: 85%;
        text-align: center;
        font-size: 10px;
    }
    .maptiler-logo { bottom: 80px; left: 20px; transform: scale(1.4); }
    
    /* MOBILE ROUTE INFO SCALING */
    #route-info { 
        transform: scale(1.25) translateX(-50%); /* Slightly lower scale to fit width */
        bottom: 130px; 
        top: auto; 
        left: 50%; 
        right: auto;
        width: auto;
        min-width: 250px; /* Wider to accommodate "Distance" text */
        text-align: center;
        padding: 12px;
    }
}
</style>
</head>
<body>

<div id="map-streets" class="map"></div>
<div id="map-hybrid" class="map" style="display:none;"></div>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Search"/>
  <div id="searchResults"></div>
  <button id="toggleRoute">Enable Routing</button>
  <select id="mode">
    <option value="driving-car">Car</option>
    <option value="foot-walking">Walking</option>
    <option value="cycling-regular">Cycling</option>
  </select>
  <button id="resetRoute">Reset Route</button>
</div>

<div id="downloadMap" title="Download Map">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#5856d6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
    <path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/>
    <path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/>
  </svg>
</div>

<div id="hybridToggle">
  <img src="https://raw.githubusercontent.com/finnhound/cartohound/7b3c8e14c393450a26d9d562c99016afad43d83a/stack%20(1).svg" alt="Hybrid Map Icon">
</div>

<div id="route-info" style="
    position: absolute;
    top: 136px;
    right: 70px;
    background: rgba(255,255,255,0.85);
    padding: 8px 10px;
    border: 1px solid #333;
    border-radius: 6px;
    font: 14px 'Inter', sans-serif;
    z-index: 25;
    pointer-events: none;
    display: none;
    white-space: nowrap;
"></div>

<div id="hint-text" class="hint-text">
  <strong>Click on route</strong> to add waypoints<br>
  <strong>Double-click</strong> waypoints to remove
</div>

<div id="loading" class="loading">Loading...</div>

<div class="attribution-text">
    <a href="https://maplibre.org/" target="_blank">MapLibre</a> | 
    <a href="https://openrouteservice.org/" target="_blank">ORS</a> | 
    © <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> | 
    © <a href="https://www.maptiler.com/" target="_blank">MapTiler</a>
</div>
<a class="maptiler-logo" href="https://www.maptiler.com" target="_blank" rel="noopener">
  <img src="https://api.maptiler.com/resources/logo.svg" alt="MapTiler logo">
</a>

<script>
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjFjMzkyNDVlOGIyNjQxYjVhMDRhNWEwNjdlMTM4MDc0IiwiaCI6Im11cm11cjY0In0=";
const MT_KEY = 'kUOJqqeRX1BMaXctsgK5';
const STREETS_URL = `https://api.maptiler.com/maps/019b2817-43ac-7a98-b15b-c204722a617b/style.json?key=${MT_KEY}`;
const HYBRID_URL = `https://api.maptiler.com/maps/hybrid/style.json?key=${MT_KEY}`;

const savedView = JSON.parse(localStorage.getItem('mapView') || 'null');
let currentStyle = localStorage.getItem('mapStyle') || 'streets';
let routingEnabled = JSON.parse(localStorage.getItem('mapRouteEnabled') || 'false');
let routingMode = document.getElementById('mode').value;

let routePoints = [];
let startMarker = null;
let endMarker = null;
let waypointMarkers = [];
const routeInfo = document.getElementById('route-info');
const loadingEl = document.getElementById('loading');
const searchBox = document.getElementById('searchBox');
const searchResults = document.getElementById('searchResults');
const hintText = document.getElementById('hint-text');

// Scalable Pin SVGs
const isMobile = window.innerHeight > window.innerWidth;
const pinSize = isMobile ? 48 : 40;
const strokeW = isMobile ? 4 : 3;

const defaultPinSVG = `<svg width="${pinSize}" height="${pinSize}" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="${strokeW}" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg>`;
const startPinSVG = `<svg width="${pinSize}" height="${pinSize}" viewBox="0 0 24 24" fill="none" stroke="#00c7be" stroke-width="${strokeW}" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg>`;
const endPinSVG = `<svg width="${pinSize}" height="${pinSize}" viewBox="0 0 24 24" fill="none" stroke="#ff9500" stroke-width="${strokeW}" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg>`;

const mapStreets = new maplibregl.Map({ container:'map-streets', style:STREETS_URL, center: savedView?.center||[0,0], zoom: savedView?.zoom ?? 1, attributionControl:false, preserveDrawingBuffer:true });
const mapHybrid = new maplibregl.Map({ container:'map-hybrid', style:HYBRID_URL, center: savedView?.center||[0,0], zoom: savedView?.zoom ?? 1, attributionControl:false, preserveDrawingBuffer:true });
[mapStreets,mapHybrid].forEach(m=>{ m.addControl(new maplibregl.NavigationControl({showCompass:true, showZoom:true}),'top-left'); });

const hybridToggleEl = document.getElementById('hybridToggle');
function showHybrid(isHybrid) {
  hybridToggleEl.classList.toggle('active', isHybrid);
  if(isHybrid){ 
    document.getElementById('map-streets').style.display='none'; 
    document.getElementById('map-hybrid').style.display='block'; 
    mapHybrid.resize(); 
    if(startMarker) startMarker.addTo(mapHybrid);
    if(endMarker) endMarker.addTo(mapHybrid);
    waypointMarkers.forEach(wp => wp.addTo(mapHybrid));
  } else { 
    document.getElementById('map-streets').style.display='block'; 
    document.getElementById('map-hybrid').style.display='none'; 
    mapStreets.resize(); 
    if(startMarker) startMarker.addTo(mapStreets);
    if(endMarker) endMarker.addTo(mapStreets);
    waypointMarkers.forEach(wp => wp.addTo(mapStreets));
  }
  currentStyle = isHybrid?'hybrid':'streets';
  localStorage.setItem('mapStyle',currentStyle);
}
showHybrid(currentStyle==='hybrid');
hybridToggleEl.onclick = ()=>showHybrid(currentStyle==='streets');

let syncing=false;
function syncView(src,tgt){ if(syncing) return; syncing=true; const c=src.getCenter(), z=src.getZoom(); tgt.jumpTo({center:[c.lng,c.lat], zoom:z}); syncing=false; }
mapStreets.on('move',()=>syncView(mapStreets,mapHybrid));
mapHybrid.on('move',()=>syncView(mapHybrid,mapStreets));
function saveView(){ const activeMap = currentStyle==='streets'?mapStreets:mapHybrid; const c=activeMap.getCenter(), z=activeMap.getZoom(); localStorage.setItem('mapView',JSON.stringify({center:[c.lng,c.lat], zoom:z})); }
mapStreets.on('moveend', saveView); mapHybrid.on('moveend', saveView);

const toggleRouteBtn = document.getElementById('toggleRoute');
function updateRouteButton(){ 
  toggleRouteBtn.textContent = routingEnabled?'Disable Routing':'Enable Routing'; 
  updateSearchPlaceholder(); 
  hintText.style.display = (routingEnabled && startMarker && endMarker) ? 'block' : 'none';
}
updateRouteButton();
toggleRouteBtn.onclick = ()=>{ 
  routingEnabled = !routingEnabled; 
  localStorage.setItem('mapRouteEnabled',routingEnabled); 
  updateRouteButton(); 
  if(!routingEnabled) clearRoute(); 
};

document.getElementById('mode').onchange = function(){ 
  routingMode = this.value; 
  if(routePoints.length >= 2) fetchRoute(); 
};

document.getElementById('resetRoute').onclick = ()=>{ 
  clearRoute(); 
  if(routingEnabled) searchBox.placeholder = "Select start"; 
};

function updateSearchPlaceholder(){
  if(!routingEnabled) searchBox.placeholder = "Search";
  else if(routingEnabled && !startMarker) searchBox.placeholder = "Select start";
  else if(routingEnabled && startMarker && !endMarker) searchBox.placeholder = "Select end";
  else searchBox.placeholder = "Search";
}

function addPin(map, lngLat, isSearch = false) {
  let svgContent = defaultPinSVG;
  let draggable = routingEnabled;
  let pinTarget = null;
  if (routingEnabled) {
    if (!startMarker || (isSearch && searchBox.placeholder.toLowerCase().includes('start'))) {
      pinTarget = 'start'; svgContent = startPinSVG;
    } else if (!endMarker || (isSearch && searchBox.placeholder.toLowerCase().includes('end'))) {
      pinTarget = 'end'; svgContent = endPinSVG;
    } else if (!isSearch) {
      pinTarget = 'end'; if(endMarker) endMarker.remove(); svgContent = endPinSVG;
    }
  }
  const el = document.createElement('div');
  el.style.width = pinSize+'px'; el.style.height = pinSize+'px'; el.style.cursor = draggable ? 'move' : 'pointer'; el.innerHTML = svgContent;
  const m = new maplibregl.Marker({ element: el, draggable: draggable }).setLngLat(lngLat).addTo(map);
  if (routingEnabled) {
    m.on('dragend', () => {
      const pos = [m.getLngLat().lng, m.getLngLat().lat];
      if (startMarker === m) routePoints[0] = pos;
      else if (endMarker === m) routePoints[routePoints.length - 1] = pos;
      if (routePoints.length >= 2) fetchRoute();
    });
  }
  if (pinTarget === 'start') {
    if (startMarker) startMarker.remove(); startMarker = m;
    if(routePoints.length === 0) routePoints = [[lngLat[0], lngLat[1]]]; else routePoints[0] = [lngLat[0], lngLat[1]];
    if (isSearch) searchBox.placeholder = "Select end";
    if(endMarker) fetchRoute();
  } else if (pinTarget === 'end') {
    if (endMarker) endMarker.remove(); endMarker = m;
    if(routePoints.length === 1) routePoints.push([lngLat[0], lngLat[1]]); else routePoints[routePoints.length - 1] = [lngLat[0], lngLat[1]];
    if (isSearch) searchBox.placeholder = "Search";
    if(startMarker && endMarker) fetchRoute();
  }
  m.getElement().addEventListener('click', (e) => {
    e.stopPropagation(); m.remove();
    if (startMarker === m) { startMarker = null; clearRoute(); }
    if (endMarker === m) { endMarker = null; clearRoute(); }
  });
  updateRouteButton();
}

function clearRoute(){
  waypointMarkers.forEach(wp => wp.remove()); waypointMarkers = [];
  if(startMarker){ startMarker.remove(); startMarker = null; }
  if(endMarker){ endMarker.remove(); endMarker = null; }
  routePoints = []; routeInfo.style.display = 'none'; hintText.style.display = 'none';
  [mapStreets,mapHybrid].forEach(m=>{ if(m.getLayer('route')) m.removeLayer('route'); if(m.getSource('route')) m.removeSource('route'); });
  updateSearchPlaceholder();
}

function fetchRoute(){
  if(routePoints.length < 2) return;
  const url = `https://api.openrouteservice.org/v2/directions/${routingMode}/geojson`;
  fetch(url, { method:'POST', headers: { "Authorization": ORS_KEY, "Content-Type": "application/json" }, body: JSON.stringify({ coordinates: routePoints }) })
  .then(res => res.json())
  .then(data => {
    if(!data.features || !data.features[0]) return;
    const feature = data.features[0]; const routeGeoJSON = feature.geometry;
    // Updated text to "Distance" and "Time"
    routeInfo.innerHTML = `Distance: ${(feature.properties.summary.distance / 1000).toFixed(2)} km | Time: ${Math.round(feature.properties.summary.duration / 60)} min`;
    routeInfo.style.display = 'block'; hintText.style.display = 'block';
    
    // Thicker line on mobile
    const lineW = isMobile ? 10 : 5;

    [mapStreets, mapHybrid].forEach(m => {
      if(m.getSource('route')){ m.removeLayer('route'); m.removeSource('route'); }
      m.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: routeGeoJSON } });
      m.addLayer({ id: 'route', type: 'line', source: 'route', paint: { 'line-color': '#0074d9', 'line-width': lineW } });
    });
    const bounds = routeGeoJSON.coordinates.reduce((b, c) => b.extend(c), new maplibregl.LngLatBounds(routeGeoJSON.coordinates[0], routeGeoJSON.coordinates[0]));
    (currentStyle === 'streets' ? mapStreets : mapHybrid).fitBounds(bounds, {padding: 100});
  });
}

function addWaypoint(lngLat) {
  if (!routingEnabled || !startMarker || !endMarker) return;
  const el = document.createElement('div');
  // Pin waypoint for mobile, dot for PC
  if(isMobile) {
      el.innerHTML = defaultPinSVG;
  } else {
      el.style.width = '18px'; el.style.height = '18px'; el.style.borderRadius = '50%';
      el.style.background = 'rgba(139, 138, 235, 0.6)'; el.style.border = '2px solid rgba(255, 255, 255, 0.8)';
  }
  
  const map = currentStyle === 'streets' ? mapStreets : mapHybrid;
  const wp = new maplibregl.Marker({ element: el, draggable: true }).setLngLat(lngLat).addTo(map);
  routePoints.splice(routePoints.length - 1, 0, [lngLat[0], lngLat[1]]); waypointMarkers.push(wp);
  wp.on('dragend', () => {
    const idx = waypointMarkers.indexOf(wp);
    if (idx !== -1) { routePoints[idx + 1] = [wp.getLngLat().lng, wp.getLngLat().lat]; fetchRoute(); }
  });
  wp.getElement().addEventListener('click', (e) => { e.stopPropagation(); removeWaypoint(wp); });
  fetchRoute();
}

function removeWaypoint(wp) {
  const idx = waypointMarkers.indexOf(wp); if (idx === -1) return;
  wp.remove(); waypointMarkers.splice(idx, 1); routePoints.splice(idx + 1, 1); fetchRoute();
}

function onMapClick(e) {
  const map = currentStyle === 'streets' ? mapStreets : mapHybrid;
  if (routingEnabled && startMarker && endMarker && map.getLayer('route')) {
    if (map.queryRenderedFeatures(e.point, { layers: ['route'] }).length > 0) { addWaypoint([e.lngLat.lng, e.lngLat.lat]); return; }
  }
  if (!routingEnabled) return; addPin(map, [e.lngLat.lng, e.lngLat.lat], false);
}

[mapStreets, mapHybrid].forEach(m => m.on('click', onMapClick));

let debounceTimer;
searchBox.addEventListener('input', () => {
  updateSearchPlaceholder(); clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    const query = searchBox.value; if(!query) { searchResults.style.display = 'none'; return; }
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
      .then(res => res.json()).then(results => {
        searchResults.innerHTML = ''; if(!results || results.length === 0) return;
        results.slice(0, 5).forEach(r => {
          const div = document.createElement('div'); div.className = 'searchItem'; div.textContent = r.display_name;
          div.onclick = () => {
            searchResults.style.display = 'none'; const lngLat = [parseFloat(r.lon), parseFloat(r.lat)];
            const map = currentStyle === 'streets' ? mapStreets : mapHybrid; map.flyTo({ center: lngLat, zoom: 14 });
            addPin(map, lngLat, true); searchBox.value = ''; updateSearchPlaceholder();
          };
          searchResults.appendChild(div);
        });
        searchResults.style.display = 'block';
      });
  }, 300);
});

document.addEventListener('click', e => { if(!searchResults.contains(e.target) && e.target !== searchBox) searchResults.style.display = 'none'; });

document.getElementById('downloadMap').onclick = () => {
  const mapCanvas = (currentStyle === 'streets' ? mapStreets : mapHybrid).getCanvas();
  const tempCanvas = document.createElement('canvas'); tempCanvas.width = mapCanvas.width; tempCanvas.height = mapCanvas.height;
  const ctx = tempCanvas.getContext('2d'); ctx.drawImage(mapCanvas, 0, 0);
  const attribution = "© openrouteservice.org | © OpenStreetMap | © MapTiler";
  ctx.font = `14px Inter, sans-serif`; const textWidth = ctx.measureText(attribution).width;
  ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; ctx.fillRect(tempCanvas.width - textWidth - 20, tempCanvas.height - 34, textWidth + 20, 34);
  ctx.fillStyle = "#333"; ctx.fillText(attribution, tempCanvas.width - textWidth - 10, tempCanvas.height - 10);
  tempCanvas.toBlob(blob => {
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `map-${Date.now()}.png`; a.click();
  }, 'image/png');
};
</script>
</body>
</html>
