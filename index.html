<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; font-family:'Inter', sans-serif; overflow: hidden; background: #000; }
.map { width:100%; height:100%; position:absolute; top:0; left:0; transition: transform 0.3s ease; }

#controls { position:absolute; top:10px; right:10px; z-index:25; background:white; padding:10px; border:1px solid #ccc; display:flex; flex-direction:column; gap:5px; border-radius:6px; }

/* GPS and Toggle Buttons */
#downloadMap, #hybridToggle, #gpsToggle { 
  position:absolute; right:10px; z-index:20; background:white; 
  padding:8px; border:1px solid #ccc; cursor:pointer; border-radius:6px; 
  width:40px; height:40px; display:flex; align-items:center; justify-content:center; 
  transition: background 0.2s; 
}
#downloadMap { top:130px; }
#gpsToggle { top:180px; }
#hybridToggle { top:230px; }

#hybridToggle.active, #gpsToggle.active { background:#ddd; }
#hybridToggle img, #gpsToggle svg { width:24px; height:24px; }

/* User Location Marker - Directional */
.user-location-marker {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.1s linear;
}

.user-location-marker svg {
  filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
}

button, select, input { font:14px 'Inter', sans-serif; }
#searchBox { width:200px; padding:4px; border-radius:4px; border:1px solid #ccc; z-index:26; position:relative; }
#searchResults { 
  position:absolute; top:42px; left:0; background:white; 
  border:1px solid #ccc; max-height:180px; overflow-y:auto; 
  width:100%; z-index:100; border-radius:4px; display:none; 
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.searchItem { padding:8px; cursor:pointer; font-size: 13px; line-height: 1.2; border-bottom: 1px solid #eee; }
.searchItem:hover { background:#eee; }

.route-info { 
    position:absolute; top: 25px; left: 50%; transform: translateX(-50%); 
    background: white; padding: 12px 20px; border: 2px solid #333; 
    font: bold 16px 'Inter', sans-serif; z-index: 25; border-radius: 8px; 
    opacity: 0.95; pointer-events: none; white-space: nowrap; display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.loading { position:absolute; top:20px; left:50%; transform:translateX(-50%); background:yellow; padding:6px 12px; border-radius:4px; z-index:40; font-weight:bold; display:none; }
.attribution-text { position:absolute; bottom:10px; right:10px; z-index:25; background:rgba(255,255,255,0.85); padding:6px 10px; font:11px 'Inter', sans-serif; border-radius:6px; border:1px solid #ccc; }
.attribution-text a { color: #0074d9; text-decoration: none; }
.maptiler-logo { position:absolute; left:10px; bottom:10px; z-index:25; }
.hint-text { position:absolute; top:290px; right:10px; z-index:20; background:rgba(255,255,255,0.95); padding:8px 12px; border:1px solid #ccc; border-radius:6px; font:12px 'Inter', sans-serif; max-width:200px; display:none; }

@media screen and (orientation: portrait) {
    #map-streets, #map-hybrid { width: 55.56%; height: 55.56%; transform: scale(1.8); transform-origin: top left; }
    #controls { width: 170px; padding: 14px; transform: scale(1.35); transform-origin: top right; top: 15px; right: 15px; }
    #searchBox { width: 145px; font-size: 16px !important; padding: 12px !important; }
    #downloadMap { top: 410px; right: 20px; transform: scale(1.7); }
    #gpsToggle { top: 490px; right: 20px; transform: scale(1.7); }
    #hybridToggle { top: 570px; right: 20px; transform: scale(1.7); }
    .maplibregl-ctrl-group { transform: scale(1.7); transform-origin: top left; margin: 25px !important; }
    .maptiler-logo { bottom: 80px; left: 20px; transform: scale(1.4); }
    #route-info { top: 130px; left: 50%; transform: translateX(-50%) scale(1.15); width: auto; min-width: 260px; max-width: 90%; text-align: center; padding: 14px; white-space: normal; }
    .user-location-marker { width: 45px; height: 45px; }
}
</style>
</head>
<body>

<div id="map-streets" class="map"></div>
<div id="map-hybrid" class="map" style="display:none;"></div>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Search"/>
  <div id="searchResults"></div>
  <button id="toggleRoute">Enable Routing</button>
  <select id="mode">
    <option value="driving-car">Car</option>
    <option value="foot-walking">Walking</option>
    <option value="cycling-regular">Cycling</option>
  </select>
  <button id="resetRoute">Reset Route</button>
</div>

<div id="downloadMap" title="Download Map">
  <svg viewBox="0 0 24 24" fill="none" stroke="#5856d6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg>
</div>

<div id="gpsToggle" title="Toggle GPS">
  <svg viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
</div>

<div id="hybridToggle"><img src="https://raw.githubusercontent.com/finnhound/cartohound/7b3c8e14c393450a26d9d562c99016afad43d83a/stack%20(1).svg" alt="Hybrid Map Icon"></div>
<div id="route-info" class="route-info"></div>
<div id="hint-text" class="hint-text"><strong>Click on route</strong> to add waypoints<br><strong>Double-click</strong> waypoints to remove</div>

<script>
const MT_KEY = 'kUOJqqeRX1BMaXctsgK5';
const STREETS_URL = `https://api.maptiler.com/maps/019b2817-43ac-7a98-b15b-c204722a617b/style.json?key=${MT_KEY}`;
const HYBRID_URL = `https://api.maptiler.com/maps/hybrid/style.json?key=${MT_KEY}`;

const savedView = JSON.parse(localStorage.getItem('mapView') || 'null');
let currentStyle = localStorage.getItem('mapStyle') || 'streets';
let watchId = null;
let currentHeading = 0;

const mapStreets = new maplibregl.Map({ container:'map-streets', style:STREETS_URL, center: savedView?.center||[0,0], zoom: savedView?.zoom ?? 1, attributionControl:false });
const mapHybrid = new maplibregl.Map({ container:'map-hybrid', style:HYBRID_URL, center: savedView?.center||[0,0], zoom: savedView?.zoom ?? 1, attributionControl:false });
[mapStreets,mapHybrid].forEach(m=>{ m.addControl(new maplibregl.NavigationControl({showCompass:true, showZoom:true}),'top-left'); });

const hybridToggleEl = document.getElementById('hybridToggle');
function showHybrid(isHybrid) {
  hybridToggleEl.classList.toggle('active', isHybrid);
  document.getElementById('map-streets').style.display = isHybrid ? 'none' : 'block';
  document.getElementById('map-hybrid').style.display = isHybrid ? 'block' : 'none';
  const activeMap = isHybrid ? mapHybrid : mapStreets;
  activeMap.resize();
  currentStyle = isHybrid ? 'hybrid' : 'streets';
  localStorage.setItem('mapStyle', currentStyle);
}
showHybrid(currentStyle==='hybrid');
hybridToggleEl.onclick = ()=>showHybrid(currentStyle==='streets');

// Directional Marker SVG
const arrowSVG = `<svg width="100%" height="100%" viewBox="0 0 40 40"><circle cx="20" cy="20" r="12" fill="#007aff" stroke="white" stroke-width="3"/><path d="M20 2L26 14H14L20 2Z" fill="#007aff" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>`;

let markerStreets = null, markerHybrid = null;

function handleOrientation(event) {
    // Check for webkit (iOS) or absolute alpha
    let heading = event.webkitCompassHeading || (360 - event.alpha);
    if (!heading) return;
    
    currentHeading = heading;
    const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
    const targetMarker = currentStyle === 'streets' ? markerStreets : markerHybrid;

    if (targetMarker) {
        targetMarker.getElement().style.transform = `rotate(${heading}deg)`;
    }
    
    if (watchId !== null) {
        activeMap.setBearing(heading);
    }
}

const gpsToggleEl = document.getElementById('gpsToggle');
gpsToggleEl.onclick = async () => {
  if (watchId !== null) {
    // DISABLE GPS
    navigator.geolocation.clearWatch(watchId);
    window.removeEventListener('deviceorientation', handleOrientation);
    watchId = null;
    gpsToggleEl.classList.remove('active');
    if(markerStreets) markerStreets.remove();
    if(markerHybrid) markerHybrid.remove();
    markerStreets = markerHybrid = null;
    // RESET TO NORTH
    mapStreets.setBearing(0);
    mapHybrid.setBearing(0);
  } else {
    // ENABLE GPS
    // iOS Permission Request
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        const response = await DeviceOrientationEvent.requestPermission();
        if (response !== 'granted') return alert("Permission denied");
    }

    gpsToggleEl.classList.add('active');
    window.addEventListener('deviceorientation', handleOrientation, true);
    
    watchId = navigator.geolocation.watchPosition((pos) => {
        const coords = [pos.coords.longitude, pos.coords.latitude];
        const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
        
        if (!markerStreets) {
            const el1 = document.createElement('div'); el1.className = 'user-location-marker'; el1.innerHTML = arrowSVG;
            const el2 = document.createElement('div'); el2.className = 'user-location-marker'; el2.innerHTML = arrowSVG;
            markerStreets = new maplibregl.Marker({element: el1}).setLngLat(coords).addTo(mapStreets);
            markerHybrid = new maplibregl.Marker({element: el2}).setLngLat(coords).addTo(mapHybrid);
            activeMap.flyTo({center: coords, zoom: 16});
        } else {
            markerStreets.setLngLat(coords);
            markerHybrid.setLngLat(coords);
            activeMap.easeTo({center: coords});
        }
    }, (err) => alert(err.message), { enableHighAccuracy: true });
  }
};

// Sync and basic map listeners
let syncing=false;
function syncView(src,tgt){ if(syncing) return; syncing=true; const c=src.getCenter(), z=src.getZoom(), b=src.getBearing(); tgt.jumpTo({center:[c.lng,c.lat], zoom:z, bearing:b}); syncing=false; }
mapStreets.on('move',()=>syncView(mapStreets,mapHybrid));
mapHybrid.on('move',()=>syncView(mapHybrid,mapStreets));
mapStreets.on('moveend', () => { const c=mapStreets.getCenter(); localStorage.setItem('mapView',JSON.stringify({center:[c.lng,c.lat], zoom:mapStreets.getZoom()})); });
</script>
</body>
</html>
